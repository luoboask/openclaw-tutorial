1:"$Sreact.fragment"
2:I[9113,["177","static/chunks/app/layout-46f5ac64a413e030.js"],"GoogleAnalytics"]
3:I[9766,[],""]
4:I[8924,[],""]
6:I[4431,[],"OutletBoundary"]
8:I[5278,[],"AsyncMetadataOutlet"]
a:I[4431,[],"ViewportBoundary"]
c:I[4431,[],"MetadataBoundary"]
d:"$Sreact.suspense"
f:I[7150,[],""]
:HL["/_next/static/css/9f24cb9bbe9b11ba.css","style"]
0:{"P":null,"b":"LNiyWt4_cNgixlXX2Aas8","p":"","c":["","blog","openclaw-memory-system-deep-dive",""],"i":false,"f":[[["",{"children":["blog",{"children":[["slug","openclaw-memory-system-deep-dive","d"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/9f24cb9bbe9b11ba.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"zh-CN","children":[["$","head",null,{"children":["$","$L2",null,{}]}],["$","body",null,{"className":"antialiased bg-white text-gray-900","children":["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":404}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}]]}]]}],{"children":["blog",["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["slug","openclaw-memory-system-deep-dive","d"],["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$L5",null,["$","$L6",null,{"children":["$L7",["$","$L8",null,{"promise":"$@9"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,[["$","$La",null,{"children":"$Lb"}],null],["$","$Lc",null,{"children":["$","div",null,{"hidden":true,"children":["$","$d",null,{"fallback":null,"children":"$Le"}]}]}]]}],false]],"m":"$undefined","G":["$f",[]],"s":false,"S":true}
10:I[2619,["619","static/chunks/619-ba102abea3e3d0e4.js","953","static/chunks/app/blog/%5Bslug%5D/page-b4828bf21a148f59.js"],""]
11:I[3874,["619","static/chunks/619-ba102abea3e3d0e4.js","953","static/chunks/app/blog/%5Bslug%5D/page-b4828bf21a148f59.js"],"ArticleContent"]
12:T1b42,
# OpenClaw 记忆系统技术详解

本文深入解析 OpenClaw AI 助手的记忆系统架构、工作原理和实现细节。

适用版本：OpenClaw 2026.2.x

---

## 概述

OpenClaw 采用混合架构设计，结合文件系统存储和向量语义搜索，实现高效、隐私友好的长期记忆功能。

### 核心设计理念

**双轨记忆系统**

- **长期记忆** (MEMORY.md)：精心维护的核心知识，持久化存储，跨会话共享
- **短期记忆** (memory/*.md)：每日自动追加的日志，按日期分片

**混合检索引擎**

- 向量搜索（语义相似度）—— 权重 70%
- BM25 全文（关键词）—— 权重 30%
- FTS5（SQLite）—— 辅助索引

**设计哲学**

- 文件优先：纯 Markdown，人类可读可编辑
- 隐私优先：本地存储，不依赖云服务
- 渐进式记忆：长期记忆精选 + 短期记忆全量

### 文件系统结构

```
~/.openclaw/workspace/
├── MEMORY.md                    # 长期记忆
├── memory/                      # 短期记忆目录
│   ├── 2026-02-14.md
│   ├── 2026-02-17.md
│   └── 2026-02-18.md
└── agents/{id}/memory/          # Agent 专属记忆
```

---

## 向量搜索原理

### 文本向量化

将文本转换为高维向量（768-4096 维）。

**示例**

> "OpenClaw Agent 工作机制"
>
> 经过嵌入模型处理后 → 768 维向量数组

**语义特性**

- 相似的文本在向量空间中距离近
- "苹果"和"水果"向量接近
- "苹果"和"iPhone"在特定语境下也接近

### 相似度计算

使用**余弦相似度**：

```
similarity = (A·B) / (||A|| × ||B||)

范围: -1 ~ 1
阈值: >0.5 认为相关
```

### 分块策略

| 参数 | 值 | 说明 |
|------|-----|------|
| chunkSize | 400 tokens | 每块大小 |
| overlap | 80 tokens | 重叠保持上下文 |
| strategy | tokens | 按 token 分割 |

**分块目的**

1. 控制向量粒度（太长会稀释语义）
2. 支持精确检索（找到具体段落）
3. 避免上下文窗口溢出

---

## 混合搜索策略

### 向量搜索 vs 关键词搜索

| 方式 | 优势 | 劣势 | 适用场景 |
|------|------|------|---------|
| 向量搜索 | 语义理解、同义词 | 精确术语匹配差 | 概念搜索 |
| BM25/FTS | 精确匹配、速度快 | 无法理解语义 | 代码、ID、错误信息 |

### BM25 算法

BM25（Best Match 25）比简单的"出现次数"更智能，考虑三个因素：

**1. 词频（TF）**

不是线性增长：
- 出现 1 次 → 基础分
- 出现 2 次 → 分数增加，但不如 2 倍
- 出现 10 次 → 分数饱和（防止关键词堆砌）

**公式**

``
score = (TF × (k1 + 1)) / (TF + k1 × (1 - b + b × (doc_len / avg_len)))

k1 = 1.2（控制词频饱和度）
b = 0.75（控制文档长度惩罚）
``

**2. 逆文档频率（IDF）**

- 常见词（如"的"）→ 出现在 99% 文档 → IDF 很低
- 专业词（如"OpenClaw"）→ 只出现在 5% 文档 → IDF 很高

**3. 文档长度归一化**

- 100字文档出现1次"Agent" → 密度 1%
- 10000字文档出现10次"Agent" → 密度 0.1%（实际相关性更低）

### FTS 全文搜索

FTS 使用**倒排索引**，比传统搜索快 100-1000 倍。

| 搜索方式 | 原理 | 速度 |
|---------|------|------|
| 传统搜索 | 线性扫描每个文档 | O(n) |
| FTS 搜索 | 直接查倒排索引 | O(1) |

**FTS5 优势**

- 比 LIKE '%关键词%' 快 100-1000 倍
- 自动按匹配度排序
- 支持布尔查询（AND / OR / NOT）

---

## 数据库存储

### SQLite + 扩展

- 标准表：files, chunks, meta
- FTS5 虚拟表：全文检索
- sqlite-vec 扩展：向量相似度计算

### 核心数据表

**files 表** —— 文件元数据

| 字段 | 说明 |
|------|------|
| path | 文件路径 |
| source | 来源（memory/sessions）|
| hash | 内容哈希（检测变化）|
| mtime | 修改时间 |
| size | 文件大小 |

**chunks 表** —— 核心数据

| 字段 | 说明 |
|------|------|
| id | 唯一标识 |
| path | 所属文件 |
| source | 来源 |
| start_line / end_line | 行号范围 |
| hash | 内容哈希 |
| model | 使用的嵌入模型 |
| text | 原始文本 |
| embedding | 序列化向量 |

### Agent 隔离

每个 Agent 拥有独立的数据库，保证数据安全和隐私。

---

## 写入时机

### 四种触发时机

1. **会话启动时** —— 检查记忆文件变化，同步到 SQLite
2. **搜索前** —— 确保搜索结果是最新的
3. **文件变化时** —— 1.5秒防抖后触发同步
4. **定时同步** —— 每30分钟自动同步一次

### 批量处理机制

**非批量的问题**

```
100 个 chunks
→ 100 次 API 调用
→ 100 次数据库写入
→ 非常慢！
``

**批量的优化**

```
100 个 chunks
→ 1 次 API 调用
→ 1 次事务写入
→ 快 10-100 倍！
``

**配置参数**

| 参数 | 值 | 说明 |
|------|-----|------|
| enabled | true | 启用批量 |
| maxSize | 100 | 每批最多 chunks |
| concurrency | 4 | 并发批数 |
| intervalMs | 1000 | 批次间隔 |
| timeoutMs | 120000 | 超时时间 |

### 索引流程

```
1. 触发条件满足
2. 扫描文件系统，计算哈希
3. 对比数据库，识别变化
4. 批量处理变化
5. 更新 files 表
6. 提交事务
``

---

## 配置选项

### 嵌入提供商

支持三种方式：

1. **远程 API** —— OpenAI / Gemini
2. **Ollama 本地** —— 推荐，免费
3. **本地 GGUF** —— 完全离线

### 搜索配置

| 参数 | 说明 |
|------|------|
| hybrid.enabled | 启用混合搜索 |
| vectorWeight | 向量权重（默认 70%）|
| textWeight | 文本权重（默认 30%）|
| minScore | 最低相似度阈值 |
| maxResults | 最大返回结果数 |

---

## 性能优化

| 优化项 | 效果 |
|--------|------|
| sqlite-vec 扩展 | 向量计算加速 |
| 嵌入缓存 | 避免重复计算 |
| 批量索引 | 减少 I/O |
| 调整 chunkSize | 默认 400，可增大减少块数 |
| 定期清理旧日志 | 控制索引规模 |

---

## 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| 搜索无结果 | 相似度低于阈值 | 降低 minScore |
| 结果不相关 | 向量/文本权重不当 | 调整 vectorWeight |
| 索引慢 | 嵌入模型慢 | 换更快的模型或使用缓存 |
| GGUF 加载失败 | 兼容性问题 | 使用 Ollama 替代 |

---

## 总结

OpenClaw 记忆系统的核心技术：

1. **文件系统存储** —— 纯 Markdown，人类可读
2. **向量语义搜索** —— 理解同义词和上下文
3. **BM25 + FTS** —— 精确关键词匹配
4. **混合融合算法** —— 综合语义和关键词优势
5. **批量处理机制** —— 优化性能和资源使用
6. **Agent 隔离** —— 保证数据安全和隐私

这套架构平衡了搜索质量、隐私保护和性能效率，是 OpenClaw 成为优秀 AI 助手的关键基础设施。

---

*文档版本: 1.0*  
*最后更新: 2026-02-24*  
*作者: OpenClaw Assistant*
    5:["$","div",null,{"className":"min-h-screen bg-gradient-to-b from-slate-50 to-white","children":["$","div",null,{"className":"max-w-4xl mx-auto px-4 py-12","children":[["$","$L10",null,{"href":"/blog","className":"text-gray-600 hover:text-orange-600 mb-8 block","children":"返回博客"}],["$","article",null,{"className":"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden","children":[["$","div",null,{"className":"bg-gradient-to-br from-orange-500 to-red-600 p-12 text-white","children":[["$","div",null,{"className":"flex items-center gap-4 mb-4 text-sm opacity-90","children":[["$","span",null,{"children":"2026-02-24"}],["$","span",null,{"children":"30 分钟"}]]}],["$","h1",null,{"className":"text-3xl font-bold","children":"OpenClaw 记忆系统技术详解"}]]}],["$","$L11",null,{"content":"$12"}]]}]]}]}]
b:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
7:null
9:{"metadata":[["$","title","0",{"children":"OpenClaw 中文教程 - 自托管 AI 网关"}],["$","meta","1",{"name":"description","content":"OpenClaw 中文教程网站 - 学习如何部署和配置 OpenClaw，将 AI 助手接入 WhatsApp、Telegram、Discord 等聊天应用"}],["$","meta","2",{"name":"author","content":"OpenClaw 中文社区"}],["$","meta","3",{"name":"keywords","content":"OpenClaw, AI, 自托管, WhatsApp, Telegram, Discord, 教程"}],["$","meta","4",{"property":"og:title","content":"OpenClaw 中文教程"}],["$","meta","5",{"property":"og:description","content":"自托管 AI 网关，连接你的所有聊天应用"}],["$","meta","6",{"property":"og:type","content":"website"}],["$","meta","7",{"name":"twitter:card","content":"summary"}],["$","meta","8",{"name":"twitter:title","content":"OpenClaw 中文教程"}],["$","meta","9",{"name":"twitter:description","content":"自托管 AI 网关，连接你的所有聊天应用"}]],"error":null,"digest":"$undefined"}
e:"$9:metadata"
